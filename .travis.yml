sudo: true
dist: trusty
language: python
python:
  - "3.5"
services:
  - docker
jobs:
  include:
  - stage: Building preCICE
    name: "Ubuntu 18.04.home (develop)"
    if: fork = false
    script:
    - docker build -f precice/Dockerfile.Ubuntu1804.home -t precice/precice-ubuntu1804.home-develop .
    after_success:
    - echo "$DOCKER_PASSWORD" | docker login -u precice --password-stdin
    - docker push precice/precice-ubuntu1804.home-develop:latest
    
  - stage: Building preCICE
    name: "Ubuntu 18.04.home (master)"
    if: fork = false
    script:
    - docker build -f precice/Dockerfile.Ubuntu1804.home -t precice/precice-ubuntu1804.home-master --build-arg branch=master .
    after_success:
    - echo "$DOCKER_PASSWORD" | docker login -u precice --password-stdin
    - docker push precice/precice-ubuntu1804.home-master:latest

  - stage: Building adapters
    name: FEniCS adapter (precice develop)
    if: fork = false
    script: >
      docker build -f adapters/Dockerfile.fenics-adapter -t $DOCKER_USERNAME/fenics-adapter-ubuntu1804.home-develop 
      --build-arg from=precice/precice-ubuntu1804.home-develop .
    after_success:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_USERNAME/fenics-adapter-ubuntu1804.home-develop

  - stage: Building adapters
    name: FEniCS adapter (precice master)
    if: fork = false
    script: >
      docker build -f adapters/Dockerfile.fenics-adapter -t $DOCKER_USERNAME/fenics-adapter-ubuntu1804.home-master 
      --build-arg from=precice/precice-ubuntu1804.home-master .
    after_success:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_USERNAME/fenics-adapter-ubuntu1804.home-master
    
  - stage: Tests
    script:
    - python system_testing.py -s fe-fe --base Ubuntu1804.home
    name: "[18.04] FEniCS <-> FEniCS (precice develop)"
    after_success:
    - python push.py -s -t fe-fe --base Ubuntu1804.home
    after_failure:
    - python push.py -t fe-fe --base Ubuntu1804.home

  - stage: Tests
    script:
    - python system_testing.py -s fe-fe --base Ubuntu1804.home --branch master
    name: "[18.04] FEniCS <-> FEniCS (precice master)"
    after_success:
    - python push.py -s -t fe-fe --base Ubuntu1804.home
    after_failure:
    - python push.py -t fe-fe --base Ubuntu1804.home

sudo: true
dist: trusty
language: python
python:
  - "3.5"
services:
  - docker
install:
  - pip install Jinja2

jobs:
  allow_failures:
    - name: "Ubuntu 18.04.sudo.mpich [Job failure permitted]"
    - name: "Ubuntu 16.04 home PETSc [Job failure permitted]"
    - name: "openFOAM adapter [PETSc] [Job failure permitted]"
    - name: "CalculiX adapter [PETSc] [Job failure permitted]"
    - name: "[16.04 PETSc] OpenFOAM <-> CalculiX [FSI] [Job failure permitted]"

  include:
    - stage: Building adapters
      name: "[16.04] SU2 adapter"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.su2-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.su2-adapter
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.su2-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop

    - name: "[16.04] CalculiX adapter"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.calculix-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.calculix-adapter
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.calculix-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop

    - name: "[16.04] deal.ii adapter"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.dealii-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.dealii-adapter
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.dealii-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop

    - name: "[16.04] OpenFOAM adapter"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.openfoam-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.openfoam-adapter
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.openfoam-adapter --operating-system ubuntu1604 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop

    - name: "[18.04] OpenFOAM adapter"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.openfoam-adapter.Ubuntu1804 --operating-system ubuntu1804 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.openfoam-adapter.Ubuntu1804
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.openfoam-adapter.Ubuntu1804 --operating-system ubuntu1804 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop

    - name: "[18.04] FEniCS adapter"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.fenics-adapter --operating-system ubuntu1804 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.fenics-adapter
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.fenics-adapter --operating-system ubuntu1804 --precice-installation home --docker-username $DOCKER_USERNAME --branch develop

    - name: "[16.04] OpenFOAM adapter [PETSc] [Job failure permitted]"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.openfoam-adapter --operating-system ubuntu1604 --precice-installation home --petsc yes --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.openfoam-adapter
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.openfoam-adapter --operating-system ubuntu1604 --precice-installation home --petsc yes --docker-username $DOCKER_USERNAME --branch develop

    - name: "[16.04] CalculiX adapter [PETSc] [Job failure permitted]"
      if: fork = false
      script:
        - python build_adapter.py --dockerfile adapters/Dockerfile.calculix-adapter --operating-system ubuntu1604 --precice-installation home --petsc yes --docker-username $DOCKER_USERNAME --branch develop
        - python push.py --adapter adapters/Dockerfile.calculix-adapter
      after_success: >-
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin &&
          python push_adapter.py --dockerfile adapters/Dockerfile.calculix-adapter --operating-system ubuntu1604 --precice-installation home --petsc yes --docker-username $DOCKER_USERNAME --branch develop

    - name: "[Build adapters on fork] Using cached version"
      if: fork = true
      script: true



    - stage: Tests
      name: "[16.04] SU2 <-> Calculix"
      script:
        - python system_testing.py -s su2-ccx --branch develop -v
        - python push.py --test su2-ccx -o

    - name: "[16.04] OpenFOAM <-> OpenFOAM"
      script:
        - python system_testing.py -s of-of --branch develop -v
        - python push.py --test of-of

    - name: "[16.04] Calculix <-> OpenFOAM"
      script:
        - python system_testing.py -s of-ccx --branch develop -v
        - python push.py --test of-ccx

    - name: "[18.04] FEniCS <-> FEniCS"
      script:
        - python system_testing.py -s fe-fe --base Ubuntu1804.home --branch develop -v
        - python push.py --test fe-fe --base Ubuntu1804.home

    - name: "[16.04] Bindings/Solverdummies"
      script:
        - python system_testing.py -s bindings --branch develop -v
        - python push.py --test bindings

    - name: "[18.04] Bindings/Solverdummies"
      script:
        - python system_testing.py -s bindings --base Ubuntu1804.home --branch develop -v
        - python push.py --test bindings --base Ubuntu1804.home

    - name: "[16.04] deal.ii <-> OpenFOAM"
      script:
        - python system_testing.py -s dealii-of --branch develop -v
        - python push.py --test dealii-of

    - name: "[18.04] nutils <-> OpenFOAM"
      script:
        - python system_testing.py -s nutils-of --base Ubuntu1804.home --branch develop -v
        - python push.py --test nutils-of --base Ubuntu1804.home -o

    - name: "[16.04] OpenFOAM <-> OpenFOAM [nearest projection]"
      script:
        - python system_testing.py -s of-of_np --branch develop -v
        - python push.py --test of-of_np

    - name: "[16.04 PETSc] OpenFOAM <-> CalculiX [FSI] [Job failure permitted]"
      script:
        - python system_testing.py -s of-ccx_fsi --base Ubuntu1604.home.PETSc --branch develop
        - python push.py --test of-ccx_fsi --petsc
